name: CD

on:
  push:
    branches: [ main ]
    tags: [ "v*" ]
    paths-ignore:
      - 'assets/**'
      - 'README.md'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  verify-charts:
    if: github.ref_type == 'tag'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Verify charts are up to date
        run: |
          set -euo pipefail

          # Extract the commit SHA that the README charts reference
          CHART_SHA=$(grep -oP 'https://raw\.githubusercontent\.com/Bobronium/copium/\K[a-f0-9]{40}(?=/assets/chart_)' README.md | head -n1 || true)

          if [[ -z "$CHART_SHA" ]]; then
            echo "ERROR: No chart URLs found in README.md"
            echo "Expected format: https://raw.githubusercontent.com/Bobronium/copium/<SHA>/assets/chart_*.svg"
            exit 1
          fi

          CURRENT_SHA="${{ github.sha }}"

          if [[ "$CHART_SHA" != "$CURRENT_SHA" ]]; then
            echo "ERROR: Charts are outdated!"
            echo "  README references charts from: $CHART_SHA"
            echo "  Current commit (tag):          $CURRENT_SHA"
            echo ""
            echo "The charts in README.md are not from this commit."
            echo "Please wait for CI to complete on this commit before tagging."
            echo ""
            echo "Steps to fix:"
            echo "  1. Delete this tag: git push --delete origin ${{ github.ref_name }}"
            echo "  2. Wait for the Build workflow to complete on commit $CURRENT_SHA"
            echo "  3. Verify charts were committed"
            echo "  4. Re-tag: git tag ${{ github.ref_name }} && git push origin ${{ github.ref_name }}"
            exit 1
          fi

          echo "âœ“ Charts are up to date (SHA: $CHART_SHA)"

  build:
    needs: verify-charts
    if: always() && !cancelled() && !failure()
    uses: ./.github/workflows/build.yaml
    with:
      is-release: ${{ github.ref_type == 'tag' }}
      run-benchmarks: ${{ github.ref == 'refs/heads/main' }}

  publish:
    needs: build
    if: (github.ref == 'refs/heads/main' || github.ref_type == 'tag') && !cancelled() && !failure()
    uses: ./.github/workflows/publish.yaml
